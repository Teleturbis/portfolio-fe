import type { Metadata } from 'next';
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { notFound } from 'next/navigation';
import { routing } from '@/i18n/routing';
import { Providers } from '@/components/providers/Providers';
import '@/app/globals.css';

export const metadata: Metadata = {
  metadataBase: new URL('https://kevinpoppe.com'),
  title: {
    default: 'Kevin Poppe - Fullstack Web Developer',
    template: '%s | Kevin Poppe',
  },
  description:
    'Ich baue performante, skalierbare Webanwendungen - von Architektur & Prototyp bis Produktion. Spezialisiert auf Next.js, React, TypeScript, Node.js und Docker.',
  keywords: [
    'Kevin Poppe',
    'Fullstack Developer',
    'Webentwickler',
    'React',
    'Next.js',
    'TypeScript',
    'Node.js',
    'Express',
    'Docker',
    'PostgreSQL',
    'MongoDB',
    'DevOps',
    'Portfolio',
    'Deutschland',
  ],
  authors: [{ name: 'Kevin Poppe', url: 'https://kevinpoppe.com' }],
  creator: 'Kevin Poppe',
  publisher: 'Kevin Poppe',
  applicationName: 'Kevin Poppe - Portfolio',
  alternates: {
    canonical: '/',
    languages: {
      'de-DE': '/',
      en: '/en',
    },
  },
  icons: {
    icon: [
      { url: '/favicon.ico' },
      { url: '/favicon-32x32.png', sizes: '32x32', type: 'image/png' },
      { url: '/favicon-16x16.png', sizes: '16x16', type: 'image/png' },
    ],
    apple: [{ url: '/apple-touch-icon.png', sizes: '180x180' }],
  },
  openGraph: {
    type: 'website',
    locale: 'de_DE',
    url: 'https://kevinpoppe.com',
    siteName: 'Kevin Poppe - Fullstack Web Developer',
    title: 'Kevin Poppe - Fullstack Web Developer',
    description:
      'Portfolio von Kevin Poppe: moderne Webentwicklung mit Next.js, React, TypeScript, Node.js und Docker - von R&D über Architektur bis Betrieb.',
    images: [
      {
        url: '/og.jpg',
        width: 1200,
        height: 630,
        alt: 'Kevin Poppe - Fullstack Web Developer',
      },
    ],
  },
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
  manifest: '/site.webmanifest',
};

export default async function LocaleLayout({
  children,
  params: { locale },
}: {
  children: React.ReactNode;
  params: { locale: string };
}) {
  // Ensure that the incoming `locale` is valid
  if (!routing.locales.includes(locale as any)) {
    notFound();
  }

  // Providing all messages to the client
  // side is the easiest way to get started
  const messages = await getMessages();

  return (
    <html lang={locale} suppressHydrationWarning>
      <body className="min-h-screen bg-background text-foreground antialiased">
        <NextIntlClientProvider messages={messages}>
          <Providers>{children}</Providers>
        </NextIntlClientProvider>
      </body>
    </html>
  );
}

  // Initialize theme from localStorage
  useEffect(() => {
    const savedTheme = localStorage.getItem('theme');
    const prefersDark = window.matchMedia(
      '(prefers-color-scheme: dark)'
    ).matches;
    const shouldBeDark = savedTheme === 'dark' || (!savedTheme && prefersDark);

    setIsDark(shouldBeDark);
    document.documentElement.classList.toggle('dark', shouldBeDark);
  }, []);

  const toggleTheme = () => {
    const newDarkState = !isDark;
    setIsDark(newDarkState);
    document.documentElement.classList.toggle('dark', newDarkState);
    localStorage.setItem('theme', newDarkState ? 'dark' : 'light');
  };

  useEffect(() => {
    const handleScroll = () => {
      const sections = ['hero', 'about', 'skills', 'projects', 'contact'];
      const scrollPosition = window.scrollY + 100;

      for (const section of sections) {
        const element = document.getElementById(section);
        if (element) {
          const { offsetTop, offsetHeight } = element;
          if (
            scrollPosition >= offsetTop &&
            scrollPosition < offsetTop + offsetHeight
          ) {
            setActiveSection(section);
            break;
          }
        }
      }
    };

    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  const scrollToSection = (id: string) => {
    const element = document.getElementById(id);
    element?.scrollIntoView({ behavior: 'smooth' });
    setMobileMenuOpen(false);
  };

  // Skills und Projects direkt aus Translations laden
  const skillsData = t.raw('Skills.items') as Array<{
    name: string;
    icon: string;
    items: string[];
  }>;

  const skills = skillsData.map((skill) => ({
    ...skill,
    icon:
      skill.icon === 'Code2'
        ? Code2
        : skill.icon === 'Database'
          ? Database
          : skill.icon === 'Palette'
            ? Palette
            : Layers,
  }));

  const projects = t.raw('Projects.items') as Array<{
    title: string;
    description: string;
    image: string;
    tags: string[];
  }>;

  return (
    <div className='bg-background min-h-screen'>
      {/* Navigation */}
      <motion.nav
        initial={{ y: -100 }}
        animate={{ y: 0 }}
        className='bg-background/80 border-border fixed top-0 right-0 left-0 z-50 border-b backdrop-blur-lg'
      >
        <div className='container mx-auto px-4 py-4'>
          <div className='flex items-center justify-between'>
            <motion.img
              src='/logo-color-full.png'
              alt='Kevin Poppe Logo'
              className='h-12 cursor-pointer'
              onClick={() => scrollToSection('hero')}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
            />

            {/* Desktop Navigation */}
            <div className='hidden items-center gap-8 md:flex'>
              {['about', 'skills', 'projects', 'contact'].map((item) => (
                <button
                  key={item}
                  onClick={() => scrollToSection(item)}
                  className={`relative transition-colors ${
                    activeSection === item
                      ? 'text-primary'
                      : 'text-foreground hover:text-primary'
                  }`}
                >
                  {t(`Navigation.nav.${item}`)}
                  {activeSection === item && (
                    <motion.div
                      layoutId='activeSection'
                      className='bg-primary absolute right-0 -bottom-1 left-0 h-0.5'
                    />
                  )}
                </button>
              ))}

              {/* Theme Toggle */}
              <motion.button
                onClick={toggleTheme}
                className='bg-muted hover:bg-muted/80 relative h-7 w-14 rounded-full p-1 transition-colors'
                whileTap={{ scale: 0.95 }}
                aria-label={t('Navigation.aria.toggleDarkMode')}
              >
                <motion.div
                  className='bg-primary flex h-5 w-5 items-center justify-center rounded-full'
                  animate={{
                    x: isDark ? 24 : 0,
                  }}
                  transition={{ type: 'spring', stiffness: 500, damping: 30 }}
                >
                  <motion.div
                    initial={false}
                    animate={{
                      scale: isDark ? 0 : 1,
                      opacity: isDark ? 0 : 1,
                      rotate: isDark ? 180 : 0,
                    }}
                    transition={{ duration: 0.2 }}
                    className='absolute'
                  >
                    <Sun size={14} className='text-white' />
                  </motion.div>
                  <motion.div
                    initial={false}
                    animate={{
                      scale: isDark ? 1 : 0,
                      opacity: isDark ? 1 : 0,
                      rotate: isDark ? 0 : -180,
                    }}
                    transition={{ duration: 0.2 }}
                    className='absolute'
                  >
                    <Moon size={14} className='text-white' />
                  </motion.div>
                </motion.div>
              </motion.button>
            </div>

            {/* Mobile Menu Button and Theme Toggle */}
            <div className='flex items-center gap-3 md:hidden'>
              <motion.button
                onClick={toggleTheme}
                className='bg-muted hover:bg-muted/80 rounded-lg p-2 transition-colors'
                whileTap={{ scale: 0.95 }}
                aria-label={t('Navigation.aria.toggleDarkMode')}
              >
                <motion.div
                  initial={false}
                  animate={{ rotate: isDark ? 180 : 0 }}
                  transition={{ duration: 0.3 }}
                >
                  {isDark ? (
                    <Moon size={20} className='text-primary' />
                  ) : (
                    <Sun size={20} className='text-primary' />
                  )}
                </motion.div>
              </motion.button>
              <button
                className='text-foreground'
                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              >
                {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
              </button>
            </div>
          </div>

          {/* Mobile Navigation */}
          {mobileMenuOpen && (
            <motion.div
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              className='mt-4 flex flex-col gap-4 pb-4 md:hidden'
            >
              {['about', 'skills', 'projects', 'contact'].map((item) => (
                <button
                  key={item}
                  onClick={() => scrollToSection(item)}
                  className={`py-2 text-left ${
                    activeSection === item ? 'text-primary' : 'text-foreground'
                  }`}
                >
                  {t(`Navigation.nav.${item}`)}
                </button>
              ))}
            </motion.div>
          )}
        </div>
      </motion.nav>

      {/* Hero Section */}
      <section
        id='hero'
        className='relative flex min-h-screen items-center justify-center overflow-hidden pt-20'
      >
        {/* Animated Background Elements */}
        <div className='absolute inset-0 overflow-hidden'>
          {[...Array(20)].map((_, i) => (
            <motion.div
              key={i}
              className='bg-primary/5 absolute rounded-full'
              style={{
                width: Math.random() * 300 + 50,
                height: Math.random() * 300 + 50,
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
              }}
              animate={{
                x: [0, Math.random() * 100 - 50],
                y: [0, Math.random() * 100 - 50],
                scale: [1, 1.2, 1],
              }}
              transition={{
                duration: Math.random() * 10 + 10,
                repeat: Infinity,
                repeatType: 'reverse',
              }}
            />
          ))}
        </div>

        <motion.div
          style={{ opacity, scale }}
          className='relative z-10 container mx-auto px-4 text-center'
        >
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: 1 }}
            transition={{ type: 'spring', duration: 1, bounce: 0.5 }}
            className='mb-8'
          >
            <Image
              src={'/logo-color-full.png'}
              alt='Kevin Poppe'
              className='mx-auto h-32 w-auto object-cover md:h-48'
              width={500}
              height={500}
              priority
            />
          </motion.div>

          <motion.h1
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
            className='text-primary mb-6'
          >
            {t('Hero.title')}
          </motion.h1>

          <motion.p
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className='text-muted-foreground mx-auto mb-12 max-w-2xl text-xl md:text-2xl'
          >
            {t('Hero.description')}
          </motion.p>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.7 }}
            className='flex flex-wrap justify-center gap-4'
          >
            <Button
              size='lg'
              onClick={() => scrollToSection('contact')}
              className='bg-primary hover:bg-secondary text-primary-foreground group'
            >
              {t('Hero.cta.contact')}
              <Send className='ml-2 h-4 w-4 transition-transform group-hover:translate-x-1' />
            </Button>
            <Button
              size='lg'
              variant='outline'
              onClick={() => scrollToSection('projects')}
              className='border-primary text-primary hover:bg-primary hover:text-primary-foreground'
            >
              {t('Hero.cta.projects')}
            </Button>
          </motion.div>

          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ delay: 1, duration: 1 }}
            className='absolute bottom-8 left-1/2 -translate-x-1/2'
          >
            <motion.div
              animate={{ y: [0, 10, 0] }}
              transition={{ duration: 2, repeat: Infinity }}
            >
              <ArrowDown className='text-primary' size={32} />
            </motion.div>
          </motion.div>
        </motion.div>
      </section>

      {/* About Section */}
      <section id='about' className='bg-muted/30 relative'>
        <SectionHero title={t('About.title')} isDark={isDark} />
        <div className='relative z-10 container mx-auto px-4 py-20'>
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
            transition={{ duration: 0.6 }}
          >
            <div className='mx-auto max-w-4xl'>
              <div className='grid items-center gap-8 md:grid-cols-2'>
                <motion.div
                  initial={{ opacity: 0, x: -50 }}
                  whileInView={{ opacity: 1, x: 0 }}
                  viewport={{ once: true }}
                  transition={{ delay: 0.2 }}
                >
                  <p className='mb-6 text-lg'>{t('About.paragraph1')}</p>
                  <p className='mb-6 text-lg'>{t('About.paragraph2')}</p>
                  <div className='mt-8 flex gap-4'>
                    <motion.a
                      href='https://github.com'
                      target='_blank'
                      rel='noopener noreferrer'
                      whileHover={{ scale: 1.1, rotate: 5 }}
                      whileTap={{ scale: 0.95 }}
                      className='bg-primary/10 text-primary hover:bg-primary hover:text-primary-foreground rounded-full p-3 transition-colors'
                    >
                      <Github size={24} />
                    </motion.a>
                    <motion.a
                      href='https://linkedin.com'
                      target='_blank'
                      rel='noopener noreferrer'
                      whileHover={{ scale: 1.1, rotate: -5 }}
                      whileTap={{ scale: 0.95 }}
                      className='bg-primary/10 text-primary hover:bg-primary hover:text-primary-foreground rounded-full p-3 transition-colors'
                    >
                      <Linkedin size={24} />
                    </motion.a>
                    <motion.a
                      href='mailto:kontakt@kevinpoppe.de'
                      whileHover={{ scale: 1.1, rotate: 5 }}
                      whileTap={{ scale: 0.95 }}
                      className='bg-primary/10 text-primary hover:bg-primary hover:text-primary-foreground rounded-full p-3 transition-colors'
                    >
                      <Mail size={24} />
                    </motion.a>
                  </div>
                </motion.div>

                <motion.div
                  initial={{ opacity: 0, x: 50 }}
                  whileInView={{ opacity: 1, x: 0 }}
                  viewport={{ once: true }}
                  transition={{ delay: 0.4 }}
                  className='relative'
                >
                  <div className='from-primary to-secondary aspect-square rounded-2xl bg-gradient-to-br p-1'>
                    <div className='bg-background flex h-full w-full items-center justify-center overflow-hidden rounded-2xl'>
                      <PixelArtImage
                        src='/guru.png'
                        alt={t('About.imageAlt')}
                        className='h-full w-full object-cover'
                      />
                    </div>
                  </div>
                </motion.div>
              </div>
            </div>
          </motion.div>
        </div>
      </section>

      {/* Skills Section */}
      <section id='skills' className='relative'>
        <SectionHero title={t('Skills.title')} isDark={isDark} />
        <div className='relative z-10 container mx-auto px-4 py-20'>
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <div className='mx-auto grid max-w-6xl gap-6 md:grid-cols-2 lg:grid-cols-4'>
              {skills.map((skill, index) => (
                <motion.div
                  key={skill.name}
                  initial={{ opacity: 0, y: 50 }}
                  whileInView={{ opacity: 1, y: 0 }}
                  viewport={{ once: true }}
                  transition={{ delay: index * 0.1 }}
                >
                  <Card className='hover:border-primary hover:shadow-primary/20 h-full border-2 p-6 transition-all duration-300 hover:shadow-lg'>
                    <motion.div
                      whileHover={{ scale: 1.1, rotate: 360 }}
                      transition={{ duration: 0.5 }}
                      className='mb-4 inline-block'
                    >
                      <div className='bg-primary/10 text-primary rounded-xl p-3'>
                        <skill.icon size={32} />
                      </div>
                    </motion.div>
                    <h3 className='mb-4'>{skill.name}</h3>
                    <div className='flex flex-wrap gap-2'>
                      {skill.items.map((item) => (
                        <Badge
                          key={item}
                          variant='outline'
                          className='border-primary/50 text-foreground hover:bg-primary hover:text-primary-foreground transition-colors'
                        >
                          {item}
                        </Badge>
                      ))}
                    </div>
                  </Card>
                </motion.div>
              ))}
            </div>
          </motion.div>
        </div>
      </section>

      {/* Projects Section */}
      <section id='projects' className='bg-muted/30 relative'>
        <SectionHero title={t('Projects.title')} isDark={isDark} />
        <div className='relative z-10 container mx-auto px-4 py-20'>
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <div className='mx-auto grid max-w-7xl gap-8 md:grid-cols-2 lg:grid-cols-3'>
              {projects.map((project, index) => (
                <motion.div
                  key={project.title}
                  initial={{ opacity: 0, y: 50 }}
                  whileInView={{ opacity: 1, y: 0 }}
                  viewport={{ once: true }}
                  transition={{ delay: index * 0.2 }}
                  whileHover={{ y: -10 }}
                >
                  <Card className='hover:border-primary hover:shadow-primary/20 h-full overflow-hidden border-2 transition-all duration-300 hover:shadow-xl'>
                    <div className='relative aspect-video overflow-hidden'>
                      <motion.div
                        whileHover={{ scale: 1.1 }}
                        transition={{ duration: 0.3 }}
                      >
                        <ImageWithFallback
                          src={project.image}
                          alt={project.title}
                          className='h-full w-full object-cover'
                        />
                      </motion.div>
                      <div className='from-secondary/80 absolute inset-0 bg-gradient-to-t to-transparent opacity-0 transition-opacity duration-300 hover:opacity-100' />
                    </div>
                    <div className='p-6'>
                      <h3 className='mb-3'>{project.title}</h3>
                      <p className='text-muted-foreground mb-4'>
                        {project.description}
                      </p>
                      <div className='flex flex-wrap gap-2'>
                        {project.tags.map((tag) => (
                          <Badge
                            key={tag}
                            className='bg-primary/10 text-primary hover:bg-primary hover:text-primary-foreground'
                          >
                            {tag}
                          </Badge>
                        ))}
                      </div>
                    </div>
                  </Card>
                </motion.div>
              ))}
            </div>
          </motion.div>
        </div>
      </section>

      {/* Contact Section */}
      <section id='contact' className='relative'>
        <SectionHero title={t('Contact.title')} isDark={isDark} />
        <div className='relative z-10 container mx-auto px-4 py-20'>
          <motion.div
            initial={{ opacity: 0, y: 50 }}
            whileInView={{ opacity: 1, y: 0 }}
            viewport={{ once: true }}
          >
            <div className='mx-auto max-w-2xl'>
              <Card className='border-primary/20 border-2 p-8'>
                <p className='mb-8 text-center text-lg'>{t('Contact.intro')}</p>
                <form className='space-y-6'>
                  <div className='grid gap-6 md:grid-cols-2'>
                    <div>
                      <label htmlFor='name' className='mb-2 block'>
                        {t('Contact.form.name.label')}
                      </label>
                      <Input
                        id='name'
                        placeholder={t('Contact.form.name.placeholder')}
                        className='border-primary/30 focus:border-primary'
                      />
                    </div>
                    <div>
                      <label htmlFor='email' className='mb-2 block'>
                        {t('Contact.form.email.label')}
                      </label>
                      <Input
                        id='email'
                        type='email'
                        placeholder={t('Contact.form.email.placeholder')}
                        className='border-primary/30 focus:border-primary'
                      />
                    </div>
                  </div>
                  <div>
                    <label htmlFor='subject' className='mb-2 block'>
                      {t('Contact.form.subject.label')}
                    </label>
                    <Input
                      id='subject'
                      placeholder={t('Contact.form.subject.placeholder')}
                      className='border-primary/30 focus:border-primary'
                    />
                  </div>
                  <div>
                    <label htmlFor='message' className='mb-2 block'>
                      {t('Contact.form.message.label')}
                    </label>
                    <Textarea
                      id='message'
                      placeholder={t('Contact.form.message.placeholder')}
                      rows={6}
                      className='border-primary/30 focus:border-primary resize-none'
                    />
                  </div>
                  <Button
                    type='submit'
                    size='lg'
                    className='bg-primary hover:bg-secondary text-primary-foreground group w-full'
                  >
                    {t('Contact.form.submit')}
                    <Send className='ml-2 h-4 w-4 transition-transform group-hover:translate-x-1' />
                  </Button>
                </form>
              </Card>
            </div>
          </motion.div>
        </div>
      </section>

      {/* Footer */}
      <footer className='border-border bg-muted/30 border-t py-8'>
        <div className='container mx-auto px-4 text-center'>
          <p className='text-muted-foreground'>{t('Footer.copyright')}</p>
        </div>
      </footer>

      {/* Floating Contact Button */}
      <motion.button
        initial={{ scale: 0 }}
        animate={{ scale: 1 }}
        transition={{ delay: 1, type: 'spring' }}
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.9 }}
        onClick={() => scrollToSection('contact')}
        className='bg-primary text-primary-foreground hover:shadow-primary/50 fixed right-8 bottom-8 z-40 rounded-full p-4 shadow-lg transition-shadow hover:shadow-xl'
        aria-label={t('Navigation.aria.contactButton')}
      >
        <Mail size={24} />
      </motion.button>
    </div>
  );
}

function PixelArtImage(props: React.ImgHTMLAttributes<HTMLImageElement>) {
  const [isInView, setIsInView] = useState(false);
  const [currentResolution, setCurrentResolution] = useState(32); // Start mit sehr niedriger Auflösung
  const imgRef = useRef<HTMLImageElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);

  useEffect(() => {
    const observer = new window.IntersectionObserver(
      ([entry]) => setIsInView(entry.isIntersecting),
      { threshold: 0.6 }
    );
    if (imgRef.current) observer.observe(imgRef.current);
    return () => observer.disconnect();
  }, []);

  // Lade Bild und ermittle Seitenverhältnis
  useEffect(() => {
    if (!props.src || typeof props.src !== 'string') return;

    const img = document.createElement('img');
    img.crossOrigin = 'anonymous';
    img.src = props.src;

    // Bild vorladen für spätere Canvas-Nutzung
    img.onload = () => {
      // Bild ist geladen und bereit
    };
  }, [props.src]);

  // Progressive Auflösungs-Animation
  useEffect(() => {
    if (!isInView) {
      setCurrentResolution(32); // Zurück auf niedrige Auflösung
      return;
    }

    // Auflösungs-Stufen: 32 → 64 → 128 → 256 → 512 (hochauflösend)
    const resolutionSteps = [32, 64, 128, 256, 512];
    let stepIndex = 0;

    const interval = setInterval(() => {
      stepIndex++;
      if (stepIndex < resolutionSteps.length) {
        setCurrentResolution(resolutionSteps[stepIndex]);
      } else {
        clearInterval(interval);
      }
    }, 150); // Jede Stufe dauert 150ms

    return () => clearInterval(interval);
  }, [isInView]);

  // Rendere Canvas mit aktueller Auflösung und korrektem Seitenverhältnis
  useEffect(() => {
    if (!props.src || typeof props.src !== 'string') return;
    if (!canvasRef.current) return;

    const img = document.createElement('img');
    img.crossOrigin = 'anonymous';
    img.src = props.src;

    img.onload = () => {
      const canvas = canvasRef.current;
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (!ctx) return;

      // Canvas-Größe basierend auf Seitenverhältnis
      const aspectRatio = img.width / img.height;
      if (aspectRatio > 1) {
        // Querformat
        canvas.width = currentResolution;
        canvas.height = Math.round(currentResolution / aspectRatio);
      } else {
        // Hochformat oder quadratisch
        canvas.height = currentResolution;
        canvas.width = Math.round(currentResolution * aspectRatio);
      }

      ctx.imageSmoothingEnabled = true;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    };
  }, [props.src, currentResolution]);

  return (
    <div className='relative h-full w-full overflow-hidden'>
      {/* Canvas für progressive Auflösung */}
      <canvas
        ref={canvasRef}
        className='h-full w-full object-cover'
        style={{
          imageRendering: currentResolution < 512 ? 'pixelated' : 'auto',
          opacity: isInView && currentResolution >= 512 ? 0 : 1,
          transition: 'opacity 1.5s ease-out',
        }}
      />

      {/* Finales hochauflösendes Bild */}
      <motion.img
        ref={imgRef}
        {...props}
        className={props.className}
        style={{
          ...(props.style || {}),
          position: 'absolute',
          inset: 0,
        }}
        initial={{ opacity: 0 }}
        animate={
          isInView && currentResolution >= 512 ? { opacity: 1 } : { opacity: 0 }
        }
        transition={{ duration: 0.3, ease: 'easeOut' }}
      />
    </div>
  );
}
