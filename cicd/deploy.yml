# Docker Build & Registry Push Jobs
# Nur f√ºr Production (main branch)

variables:
  # Teleturbis Registry Konfiguration
  REGISTRY_URL: 'registry.teleturbis.de'
  IMAGE_NAME: 'registry.teleturbis.de/portfolio'
  # Docker in Docker f√ºr Container Builds
  DOCKER_TLS_CERTDIR: '/certs'
  #! REMOVE THIS - ONLY FOR TESTING
  REGISTRY_USER: 'admin'
  REGISTRY_PASSWORD: 'TeleTurbis2024!'

# Docker Build f√ºr Production (main branch)
docker-build-production:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    IMAGE_TAG: 'v$CI_COMMIT_SHORT_SHA'
  before_script:
    - echo "üê≥ Setting up Docker environment..."
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD $REGISTRY_URL
  script:
    - echo "üèóÔ∏è Building Docker image for production..."
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker build -t $IMAGE_NAME:latest .
    - echo "üì§ Pushing to registry..."
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
    - echo "‚úÖ Production image pushed successfully"
    - echo "üì¶ Image: $IMAGE_NAME:latest"
    - echo "ÔøΩÔ∏è Tag: $IMAGE_TAG"
    - echo "üîó Commit: $CI_COMMIT_SHA"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - build
