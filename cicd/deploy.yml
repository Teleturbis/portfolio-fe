# Docker Build & Registry Push Jobs

variables:
  # Teleturbis Registry Konfiguration
  REGISTRY_URL: 'registry.teleturbis.de'
  IMAGE_NAME: 'registry.teleturbis.de/portfolio'
  # Docker in Docker für Container Builds
  DOCKER_TLS_CERTDIR: '/certs'

# Docker Build für Production
docker-build-production:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    IMAGE_TAG: 'v$CI_COMMIT_SHORT_SHA'
  before_script:
    - echo "Setting up Docker environment..."
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin "$REGISTRY_URL"
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker build -t $IMAGE_NAME:latest .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:latest
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - build

# Docker Build für Staging
docker-build-staging:
  stage: deploy
  image: docker:20.10.16
  services:
    - docker:20.10.16-dind
  variables:
    IMAGE_TAG: 'staging-$CI_COMMIT_SHORT_SHA'
  before_script:
    - echo "Setting up Docker environment..."
    - echo "$REGISTRY_PASSWORD" | docker login -u "$REGISTRY_USER" --password-stdin "$REGISTRY_URL"
  script:
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker build -t $IMAGE_NAME:staging .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - docker push $IMAGE_NAME:staging
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  needs:
    - build

# Trigger Portainer Service Update via Webhook
trigger-deployment:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "Triggering Portainer service update..."
    - |
      curl -X POST "$PORTAINER_WEBHOOK_URL" \
        -H "Content-Type: application/json" || echo "Webhook failed - continuing anyway"
    - echo "Portainer webhook triggered successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - docker-build-production
  when: manual
  allow_failure: true

# Trigger Staging Environment Update via Webhook
trigger-staging-deployment:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "Triggering Portainer staging service update..."
    - |
      curl -X POST "$PORTAINER_STAGING_WEBHOOK_URL" \
        -H "Content-Type: application/json" || echo "Staging webhook failed - continuing anyway"
    - echo "Portainer staging webhook triggered successfully"
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
  needs:
    - docker-build-staging
  when: manual
  allow_failure: true
